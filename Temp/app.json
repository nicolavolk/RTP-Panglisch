[{"name":"App.R","content":"library(shiny)\nlibrary(ggplot2)\nlibrary(munsell)\nlibrary(DT)\nlibrary(patchwork)\nlibrary(writexl)\nlibrary(htmlwidgets)\n\n# ==========================================================\n# MODUL DEFINITION: UI (Für einen einzelnen Athleten)\n# ==========================================================\nathleteModuleUI <- function(id, label = \"Athlete\") {\n  # Namespace Funktion erstellen\n  ns <- NS(id)\n  \n  tagList(\n    sidebarLayout(\n      sidebarPanel(\n        h4(\"Athlete Info\"),\n        textInput(ns(\"athlete\"), \"Name\", value = label),\n        numericInput(ns(\"mass\"), \"Weight (kg)\", value = 100, min = 30, max = 150, step = 0.01),\n        \n        hr(),\n        \n        # --- STEUERUNG FÜR TAB 2 (TRAINING) ---\n        conditionalPanel(\n          condition = paste0(\"input['\", ns(\"main_tabs\"), \"'] == 'Training' || input['\", ns(\"main_tabs\"), \"'] == 'Variable Loading'\"),\n          h4(\"Today's Performance\"),\n          helpText(\"Results of the Free Sprint today:\"),\n          numericInput(ns(\"daily_dist\"), \"Distance (m)\", value = 30),\n          numericInput(ns(\"daily_time\"), \"Time (s)\", value = 4.40, step = 0.01),\n          numericInput(ns(\"daily_vmax\"), HTML(\"V<sub>max<\/sub> (m/s)\"), value = 9.00, step = 0.01),\n          \n          hr(),\n          p(em(\"The entered values combine the existing L-v Profile in the Profiling Tab with loaded sprints and update it with today's top speed.\"))\n        )\n      ),\n      \n      mainPanel(\n        tabsetPanel(id = ns(\"main_tabs\"),\n                    \n                    # ----------------------------------------------------------\n                    # TAB 1: PROFILING\n                    # ----------------------------------------------------------\n                    tabPanel(\"Profiling\",\n                             br(),\n                             h3(\"1. Enter Data\"),\n                             helpText(em(HTML(\"A standard of 10%, 20% and 30% of the ahtlete's weight is set and the loads are calculated accordingly. Values can be overwritten. Please enter the observed V<sub>max<\/sub>.\"))),\n                             DTOutput(ns(\"lv_table\")),\n                             br(),\n                             \n                             # Info Box (Regression Results)\n                             verbatimTextOutput(ns(\"plot_info\")),\n                             \n                             h3(\"2. Profil Analysis\"),\n                             plotOutput(ns(\"plot\"), height = \"600px\"),\n                             \n                             br(),\n                             \n                             verbatimTextOutput(ns(\"vd_output\")),\n                             br(),\n                             \n                             # Plot Settings\n                             wellPanel(\n                               h4(\"Plot Display Setting\"),\n                               fluidRow(\n                                 column(4, checkboxInput(ns(\"show_zones\"), HTML(\"Display V<sub>dec<\/sub> Zones\"), value = FALSE)),\n                                 column(4, checkboxInput(ns(\"show_power\"), \"Display Power curve\", value = FALSE)),\n                                 column(4, checkboxInput(ns(\"show_individual\"), \"Display Slider\", value = FALSE))\n                               ),\n                               conditionalPanel(\n                                 condition = paste0(\"input['\", ns(\"show_individual\"), \"'] == true\"),\n                                 hr(),\n                                 sliderInput(ns(\"vd_slider\"), HTML(\"V<sub>dec<\/sub> (%)\"), min = 0, max = 80, value = 50, step = 1, width = \"100%\")\n                               )\n                             ),\n                             \n                             # --- PLOT DOWNLOAD BUTTON NUR HIER ---\n                             downloadButton(ns(\"download_plot\"), \"Download Plot (PNG)\", class = \"btn-info\", style = \"width: 100%;\"),\n                             \n                             br(), hr(),\n                             h3(\"3. Prediction table\"),\n                             helpText(em(HTML(\"Based on the V<sub>inc/dec<\/sub> values for Load (kg), BW (%), and expected velocity (m/s) for that condition are displayed. \n                                              A negative value for V<sub>inc/dec<\/sub> would indicate a velocity increase (over speed).\"))),\n                             DTOutput(ns(\"predict_table\")),\n                             \n                             \n                    ),\n                    \n                    # ----------------------------------------------------------\n                    # TAB 2: TRAINING\n                    # ----------------------------------------------------------\n                    tabPanel(\"Training\",\n                             br(),\n                             h3(\"Today's Session\"),\n                             helpText(em(HTML(\"Based on the daily performance (left) and the L-v Profile, the recommended load and target velocity are presented.\\n \n                                              Please enter your targeted velocity decrease - V<sub>dec<\/sub> (%).\"))),\n                             br(),\n                             DTOutput(ns(\"training_table\")),\n                             br(),\n                             h4(em(\"Information\")),\n                             tags$ul(\n                               tags$li(strong(HTML(\"Target V<sub>dec<\/sub>:\")), \" The targeted velocity decrement.\"),\n                               tags$li(strong(\"Rec. Load:\"), \" The recommended load based on the daily performance \",HTML(\"(v<sub>max<\/sub>).\")),\n                               tags$li(strong(HTML(\"Real V<sub>dec<\/sub>:\")), \" Calculates the real decrement in velocity after the entry of data.\")\n                             )\n                    ),\n                    \n                    # ----------------------------------------------------------\n                    # TAB 3: 1080 VARIABLE LOADING\n                    # ----------------------------------------------------------\n                    tabPanel(\"Variable Loading\",\n                             br(),\n                             h3(\"Variable Loading\"),\n                             \n                             wellPanel(\n                               fluidRow(\n                                 column(6, \n                                        numericInput(ns(\"trans_perc\"), HTML(\"Transition at % of Daily V<sub>max<\/sub>\"), value = 90, step = 1),\n                                        helpText(HTML(\"At which percentage (%) of today's V<sub>max<\/sub> should the target load be reached?\"))\n                                 ),\n                                 column(6, \n                                        numericInput(ns(\"end_load_input\"), \"Target Load (kg)\", value = 1.0, step = 0.1, min = 0),\n                                        helpText(\"The Target load is the load the user will feel when the speed reaches the preset target level (Target Speed).\")\n                                 )\n                               )\n                             ),\n                             hr(),\n                             br(),\n                             DTOutput(ns(\"variable_table\")),\n                             br(),\n                             h4(em(\"Information\")),\n                             p(\"The \", strong(\"Start load\"), \"is the load when the machine is idle and athlete is standing still.\",\n                               \"The System calculates the \", strong(\"Start Load\"), HTML(\"based on the entered V<sub>dec<\/sub>.\")),\n                             p(\"The\", strong(\"Target load\"), \"is the load the user will feel when the speed reaches the preset target level (Target Speed).\"),\n                             p(\"The\", strong(\"Target Speed\"), \"is the speed selected at which the Target Load will be reached. The lower the value, the sooner the Target Load resistance will be reached as the athlete accelerates.\"),\n                             \n                             em(HTML(\"Example: At a target speed of 90% of a 9.0 m/s V<sub>max<\/sub>, the target load (e.g., 1kg) is reached at 8.10 m/s.\"))\n                    )\n        ),\n        \n        # --- EXCEL DOWNLOAD BUTTON GLOBAL (FÜR ALLE TABS) ---\n        br(), hr(),\n        downloadButton(ns(\"download_excel\"), \"Download Data (Excel)\", class = \"btn-success\", style = \"width: 100%;\"),\n        br(), br()\n      )\n    )\n  )\n}\n\n# ==========================================================\n# MODUL DEFINITION: SERVER (Logik für einen einzelnen Athleten)\n# ==========================================================\nathleteModuleServer <- function(id, initial_values = NULL) {\n  moduleServer(id, function(input, output, session) {\n    \n    # ----------------------------------------------------------\n    # 1. DATEN & INITIALISIERUNG\n    # ----------------------------------------------------------\n    \n    # Update des Gewichts-Inputs\n    if (!is.null(initial_values) && !is.null(initial_values$mass)) {\n      updateNumericInput(session, \"mass\", value = initial_values$mass)\n    }\n    \n    default_df <- reactive({\n      bw_defaults <- c(1, 10, 20, 30, NA, NA)\n      vpeak_defaults <- c(9.22, 7.42, 5.72, 4.2, NA, NA)\n      calc_mass <- input$mass\n      \n      if (!is.null(initial_values)) {\n        if (!is.null(initial_values$BW)) bw_defaults <- initial_values$BW\n        if (!is.null(initial_values$vpeak)) vpeak_defaults <- initial_values$vpeak\n        if (!is.null(initial_values$mass)) calc_mass <- initial_values$mass\n      }\n      \n      len <- max(length(bw_defaults), length(vpeak_defaults))\n      length(bw_defaults) <- len\n      length(vpeak_defaults) <- len\n      \n      df <- data.frame(\n        BW = bw_defaults,\n        Load = round(bw_defaults * calc_mass / 100, 1),\n        vpeak = vpeak_defaults\n      )\n      \n      # ERSTE ZEILE IMMER 1 KG & 1%\n      if (nrow(df) > 0) {\n        df$BW[1]   <- 1\n        df$Load[1] <- 1.0\n      }\n      df\n    })\n    \n    rv <- reactiveValues(data = NULL)\n    \n    observe({\n      if (is.null(rv$data)) rv$data <- default_df()\n    })\n    \n    # Update Load bei Gewichtsänderung\n    observeEvent(input$mass, {\n      req(rv$data)\n      df <- rv$data\n      if(\"BW\" %in% colnames(df)) {\n        df$Load <- round(df$BW * input$mass / 100, 1)\n        if (nrow(df) > 0) {\n          df$BW[1]   <- 1\n          df$Load[1] <- 1.0\n        }\n        rv$data <- df\n      }\n    }, ignoreInit = TRUE)\n    \n    \n    # ----------------------------------------------------------\n    # 2. TABELLE EDITIEREN (TAB 1)\n    # ----------------------------------------------------------\n    output$lv_table <- renderDT({\n      req(rv$data)\n      datatable(rv$data,\n                editable = TRUE,\n                rownames = FALSE,\n                colnames = c(\"BW (%)\", \"Load (kg)\", \"v<sub>max<\/sub> (m/s)\"),\n                escape = FALSE,\n                options = list(dom = 't', paging = FALSE,\n                               columnDefs = list(list(className = 'dt-center', targets = \"_all\")))\n      ) %>%\n        formatRound(columns = \"vpeak\", digits = 2) %>%\n        formatRound(columns = \"Load\", digits = 1)\n    })\n    \n    observeEvent(input$lv_table_cell_edit, {\n      req(rv$data)\n      if (nrow(rv$data) == 0) return()\n      \n      info <- input$lv_table_cell_edit\n      df <- rv$data\n      \n      if (info$row > nrow(df)) return()\n      if ((info$col + 1) > ncol(df)) return()\n      \n      col <- colnames(df)[info$col + 1]\n      new_val <- suppressWarnings(as.numeric(info$value))\n      \n      df[info$row, col] <- new_val\n      if (col == \"BW\") df$Load <- round(df$BW * input$mass / 100, 1)\n      rv$data <- df\n    })\n    \n    # ----------------------------------------------------------\n    # 3. REGRESSION ENGINE (TAB 1)\n    # ----------------------------------------------------------\n    regression <- reactive({\n      df <- rv$data\n      df_clean <- df[complete.cases(df), ]\n      if (nrow(df_clean) < 2) return(NULL)\n      \n      fit <- lm(vpeak ~ Load, data = df_clean)\n      intercept <- coef(fit)[1]\n      slope <- coef(fit)[2]\n      r2 <- summary(fit)$r.squared\n      max_load <- -intercept / slope\n      \n      list(df = df, fit = fit, intercept = intercept, slope = slope, r2 = r2, max_load = max_load)\n    })\n    \n    # ----------------------------------------------------------\n    # 4. PREDICTION TABLE (TAB 1)\n    # ----------------------------------------------------------\n    predict_df <- reactiveVal(\n      data.frame(\n        Vdec = unique(c(seq(-20, -2, by = 2.5), seq(5, 70, by = 5))),\n        Load = NA_real_, BW_Percent = NA_real_, Velocity = NA_real_\n      )\n    )\n    \n    observe({\n      reg <- regression()\n      req(reg)\n      df <- predict_df()\n      df$Velocity <- reg$intercept * (1 - df$Vdec / 100)\n      df$Load <- (df$Velocity - reg$intercept) / reg$slope\n      df$BW_Percent <- (df$Load / input$mass) * 100\n      df <- df[, c(\"Vdec\", \"Load\", \"BW_Percent\", \"Velocity\")]\n      predict_df(df)\n    })\n    \n    output$predict_table <- renderDT({\n      datatable(predict_df(), editable = FALSE, rownames = FALSE,\n                colnames = c(\"V<sub>inc/dec<\/sub> (%)\", \"Load (kg)\", \"BW (%)\", \"Velocity (m/s)\"),\n                escape = FALSE, options = list(dom = 't', paging = FALSE, columnDefs = list(list(className = 'dt-center', targets = \"_all\")))) %>% \n        formatRound(columns = c('Load', 'Velocity', 'BW_Percent'), digits = 1)\n    })\n    \n    # ----------------------------------------------------------\n    # 5. PLOT LOGIC (REACTIVE)\n    # ----------------------------------------------------------\n    # Wir lagern den Plot in eine reactive Expression aus, \n    # damit wir ihn für Anzeige UND Download nutzen können.\n    reactive_plot <- reactive({\n      reg <- regression()\n      req(reg)\n      \n      df <- reg$df\n      p <- ggplot(df, aes(x = Load, y = vpeak))\n      y_limit_max <- max(df$vpeak, reg$intercept, na.rm=TRUE) * 1.1\n      \n      if (input$show_zones) {\n        cuts_vdec <- seq(0, 80, by = 10)\n        boundary_loads <- (-reg$intercept * (cuts_vdec / 100)) / reg$slope\n        rect_data <- data.frame(xmin = head(boundary_loads, -1), xmax = tail(boundary_loads, -1),\n                                ymin = -Inf, ymax = Inf, Zone = factor(paste0(head(cuts_vdec, -1), \"-\", tail(cuts_vdec, -1), \"%\")))\n        custom_colors <- c(\"springgreen4\", \"seagreen3\", \"palegreen1\", \"palegoldenrod\", \"salmon1\", \"tomato3\", \"firebrick3\", \"darkred\")\n        \n        p <- p + geom_rect(data = rect_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = Zone), inherit.aes = FALSE, alpha = 0.4) +\n          scale_fill_manual(values = custom_colors, expression(V[dec])) +\n          geom_rect(data = rect_data, aes(xmin = xmin, xmax = xmax, ymin = 0.7, ymax = 1.3), fill = \"white\", inherit.aes = FALSE, alpha = 0.7)\n        \n        y_top <- 1.0; tick_size <- 0.2\n        zone_labels <- data.frame(Label = c(\"Technical\", \"Speed-Strength\", \"Power\", \"Strength-Speed\"), Vdec_Mid = c(5, 25, 50, 70))\n        zone_labels$x_pos <- (-reg$intercept * (zone_labels$Vdec_Mid / 100)) / reg$slope\n        boundary_pct <- c(0, 10, 40, 60, 80)\n        boundary_x  <- (-reg$intercept * (boundary_pct / 100)) / reg$slope\n        tick_data <- data.frame(x = boundary_x)\n        \n        p <- p + geom_text(data = zone_labels, aes(x = x_pos, y = y_top, label = Label), color = \"black\", fontface = \"bold\", size = 5, inherit.aes = FALSE) +\n          geom_segment(data = tick_data, aes(x = x, xend = x, y = y_top - tick_size, yend = y_top + tick_size), color = \"black\", size = 0.8, inherit.aes = FALSE)\n      }\n      \n      line_df <- data.frame(Load = c(0, reg$max_load), vpeak = reg$intercept + reg$slope * c(0, reg$max_load))\n      p <- p + geom_point(shape = 23, size = 4, fill = \"black\") + geom_line(data = line_df, aes(x = Load, y = vpeak), color = \"red3\", linewidth = 1.2) + geom_line(color = \"black\", linetype = \"dashed\", alpha = 0.5, na.rm = TRUE) \n      \n      scaling_factor <- 1 \n      if (input$show_power) {\n        x_seq <- seq(0, reg$max_load, length.out = 100)\n        y_vel <- reg$intercept + reg$slope * x_seq; y_pow <- x_seq * 9.81 * y_vel \n        max_pow_val <- max(y_pow, na.rm = TRUE); target_h <- y_limit_max * 0.8\n        scaling_factor <- max_pow_val / target_h; power_breaks <- seq(0, max_pow_val + 250, by = 200)\n        power_df <- data.frame(Load = x_seq, PowerScaled = y_pow / scaling_factor)\n        p <- p + geom_line(data = power_df, aes(x = Load, y = PowerScaled), color = \"black\", linewidth = 0.7, linetype = \"solid\") \n      }\n      \n      if (input$show_individual) {\n        t_vel <- reg$intercept * (1 - input$vd_slider / 100); t_load <- (t_vel - reg$intercept) / reg$slope\n        p <- p + annotate(\"segment\", x = 0, xend = t_load, y = t_vel, yend = t_vel, linetype = \"dotdash\", color = \"blue3\", linewidth = 1) +\n          annotate(\"segment\", x = t_load, xend = t_load, y = 0, yend = t_vel, linetype = \"dotdash\", color = \"blue3\", linewidth = 1) +\n          annotate(\"point\", x = t_load, y = t_vel, color = \"blue3\", size = 3) +\n          annotate(\"text\", x = 1, y = t_vel-0.2, label = paste0(\"-\", input$vd_slider, \"%\"), hjust = -0.2, color = \"blue3\", fontface = \"bold\") +\n          annotate(\"text\", x = t_load, y = 0.2, label = paste0(sprintf(\"%.1f\", t_load), \" kg\"), hjust = -0.2, color = \"blue3\", fontface = \"bold\")\n      }\n      \n      x_max_val <- max(reg$max_load * 1.1, 30); x_breaks_custom <- seq(0, x_max_val, by = 5) \n      sec_axis_y_def <- if (input$show_power) sec_axis(~ . * scaling_factor, name = \"Power [W]\", breaks = power_breaks) else waiver() \n      \n      p_main <- p + theme_classic(base_size = 16) +\n        scale_x_continuous(breaks = x_breaks_custom, expand = c(0, 0), limits = c(0, x_max_val)) +\n        scale_y_continuous(limits = c(0, y_limit_max), breaks = seq(0, 15, by = 0.5), expand = c(0, 0), sec.axis = sec_axis_y_def) +\n        labs(title = paste(\"Load–Velocity Profile -\", input$athlete, \"\\n\"), x = \"Load (kg)\", y = \"Velocity (m/s)\") +\n        theme(plot.title = element_text(size = 18, face = \"bold.italic\"), axis.title.x = element_text(hjust = 0.9, face = \"italic\", size = 13),\n              axis.title.y = element_text(hjust = 0.9, face = \"italic\", color = \"black\", size = 13),\n              axis.title.y.right = element_text(angle = 90, hjust = 0.9, face = \"italic\", color = \"black\"),\n              axis.text.y.right = element_text(color = \"black\"), axis.line.y.right = element_line(color = \"black\"),\n              axis.ticks.y.right = element_line(color = \"black\"), legend.position = c(0.95, 0.95), legend.justification = c(\"right\", \"top\"),\n              legend.background = element_rect(fill = alpha(\"white\", 0.8), color = NA), plot.margin = margin(t = 5.5, r = 5.5, b = 0, l = 5.5, unit = \"pt\"))\n      \n      max_bw_val <- x_max_val / input$mass * 100; bw_breaks_custom <- seq(0, max_bw_val + 5, by = 5) \n      p_bw <- ggplot() + geom_point(data = data.frame(x = 0, y = 0), aes(x, y), alpha = 0) +\n        scale_x_continuous(limits = c(0, x_max_val), breaks = x_breaks_custom, expand = c(0, 0), sec.axis = sec_axis(~ . / input$mass * 100, name = NULL, breaks = bw_breaks_custom)) +\n        scale_y_continuous(limits = c(0, 1), expand = c(0, 0)) + labs(x = \"Load (%BW)\", y = NULL) +\n        theme_classic(base_size = 16) + theme(panel.background = element_blank(), plot.background = element_blank(), panel.border = element_blank(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.line.x.bottom = element_blank(), axis.ticks.x.bottom = element_blank(), axis.text.x.bottom = element_blank(), axis.title.x.bottom = element_text(size = 13, face = \"italic\", color = \"black\", hjust = 0.925, margin = margin(t = 0)), axis.text.x.top = element_text(color = \"black\", size = 12), axis.line.x.top = element_line(color = \"black\"), axis.ticks.x.top = element_line(color = \"black\"), plot.margin = margin(t = 0, r = 5.5, b = 5.5, l = 5.5, unit = \"pt\"))\n      \n      p_main / p_bw + plot_layout(heights = c(1, 0.01))\n    })\n    \n    # OUTPUT: PLOT ANZEIGEN\n    output$plot <- renderPlot({\n      reactive_plot()\n    })\n    \n    output$plot_info <- renderPrint({\n      reg <- regression(); req(reg)\n      cat(\"Regression Results:\\n-------------------\\n\", \"L0 (Max Load) :  \", sprintf(\"%.1f\", reg$max_load), \" kg\\n\",\n          \"v0 (Intercept):  \", sprintf(\"%.2f\", reg$intercept), \" m/s | \", sprintf(\"%.1f\", reg$intercept*3.6), \" km/h\\n\",\n          \"Slope:           \", sprintf(\"%.4f\", reg$slope), \"\\n\", \"R²:               \", sprintf(\"%.3f\", reg$r2), \"\\n\", sep = \"\")\n    })\n    \n    output$vd_output <- renderPrint({\n      reg <- regression(); req(reg)\n      t_vel <- reg$intercept * (1 - input$vd_slider / 100); t_load <- (t_vel - reg$intercept) / reg$slope\n      cat(\"Target Velocity : \", sprintf(\"%.2f\", t_vel), \" m/s\\n\", \"Target Load (kg): \", sprintf(\"%.1f\", t_load), \" kg\\n\",\n          \"          equals: \", sprintf(\"%.1f\", t_load / input$mass*100), \" %BW\\n\", sep = \"\")\n    })\n    \n    # ----------------------------------------------------------\n    # 6. TRAINING REGRESSION & TABLE\n    # ----------------------------------------------------------\n    daily_regression <- reactive({\n      req(input$daily_vmax, rv$data)\n      original <- rv$data; clean <- original[complete.cases(original), ]\n      if(nrow(clean) > 1) {\n        load_data <- clean[-1, ]; daily_point <- data.frame(BW = 0, Load = 1, vpeak = input$daily_vmax)\n        training_data <- rbind(daily_point[, c(\"Load\", \"vpeak\")], load_data[, c(\"Load\", \"vpeak\")])\n        fit <- lm(vpeak ~ Load, data = training_data)\n        return(list(intercept = coef(fit)[1], slope = coef(fit)[2]))\n      }\n      return(NULL)\n    })\n    \n    rv_training <- reactiveValues(\n      df = data.frame(Vdec_Target = rep(NA_real_, 10), Rec_Load = rep(NA_real_, 10), Target_Vel = rep(NA_real_, 10),\n                      Dist = rep(NA_real_, 10), Time = rep(NA_real_, 10), Real_Vmax = rep(NA_real_, 10), Real_Vdec = rep(NA_real_, 10))\n    )\n    \n    output$training_table <- renderDT({\n      datatable(rv_training$df, editable = TRUE, rownames = TRUE,\n                colnames = c(\"Target V<sub>dec<\/sub> (%)\", \"Rec. Load (kg)\", \"Target Vel (m/s)\", \"Distance (m)\", \"Time (s)\", \"Real V<sub>max<\/sub> (m/s)\", \"Real V<sub>dec<\/sub> (%)\"),\n                escape = FALSE, options = list(dom = 't', paging = FALSE, columnDefs = list(list(className = 'dt-center', targets = \"_all\")))) %>%\n        formatRound(columns = c(\"Rec_Load\", \"Target_Vel\", \"Real_Vmax\", \"Real_Vdec\"), digits = 2) %>%\n        formatRound(columns = \"Rec_Load\", digits = 1) %>% formatStyle('Real_Vdec', 'Vdec_Target', backgroundColor = styleEqual(NA, 'white'), color = 'black')\n    })\n    \n    observeEvent(input$training_table_cell_edit, {\n      info <- input$training_table_cell_edit; df <- rv_training$df; daily_reg <- daily_regression()\n      row_idx <- info$row; col_idx <- info$col; new_val <- as.numeric(info$value)\n      df[row_idx, col_idx] <- new_val\n      if (col_idx == 1 && !is.null(daily_reg) && !is.na(new_val)) {\n        t_vel <- daily_reg$intercept * (1 - new_val / 100); t_load <- round((t_vel - daily_reg$intercept) / daily_reg$slope, 1)\n        df[row_idx, 2] <- t_load; df[row_idx, 3] <- t_vel; df[row_idx, 4] <- 30\n      }\n      if (col_idx == 6 && !is.null(daily_reg) && !is.na(new_val)) {\n        v0_today <- daily_reg$intercept; real_vdec <- (1 - new_val / v0_today) * 100; df[row_idx, 7] <- real_vdec\n      }\n      rv_training$df <- df\n    })\n    \n    # --- TAB 3: 1080 VARIABLE LOADING ---\n    rv_variable <- reactiveValues(df = data.frame(Start_Vdec = rep(NA_real_, 10), Start_Load = rep(NA_real_, 10), End_Load = rep(1.0, 10), Trans_Vel = rep(NA_real_, 10), Dist = rep(NA_real_, 10), Time = rep(NA_real_, 10), Real_Vmax = rep(NA_real_, 10)))\n    \n    output$variable_table <- renderDT({\n      datatable(rv_variable$df, editable = TRUE, rownames = TRUE,\n                colnames = c(\"Start V<sub>dec<\/sub> (%)\", \"Start Load (kg)\", \"Target Load (kg)\", \"Target Speed (m/s)\", \"Distance (m)\", \"Time (s)\", \"Real V<sub>max<\/sub> (m/s)\"),\n                escape = FALSE, options = list(dom = 't', paging = FALSE, columnDefs = list(list(className = 'dt-center', targets = \"_all\")))) %>% \n        formatRound(columns = c(\"Trans_Vel\", \"Real_Vmax\"), digits = 2) %>% formatRound(columns = c(\"Start_Load\", \"End_Load\"), digits = 1)\n    })\n    \n    observeEvent(input$variable_table_cell_edit, {\n      info <- input$variable_table_cell_edit; df <- rv_variable$df; daily_reg <- daily_regression()\n      df[info$row, info$col] <- as.numeric(info$value)\n      if (info$col == 1 && !is.null(daily_reg) && !is.na(df[info$row, 1])) {\n        t_vel_start <- daily_reg$intercept * (1 - df[info$row, 1] / 100)\n        df[info$row, 2] <- round((t_vel_start - daily_reg$intercept) / daily_reg$slope, 1)\n        df[info$row, 5] <- 40; df[info$row, 4] <- input$daily_vmax * (input$trans_perc / 100)\n        if(is.na(df[info$row, 3])) df[info$row, 3] <- input$end_load_input\n      }\n      rv_variable$df <- df\n    })\n    \n    # ----------------------------------------------------------\n    # 7. DOWNLOAD HANDLERS\n    # ----------------------------------------------------------\n    \n    # A) EXCEL DOWNLOAD\n    output$download_excel <- downloadHandler(\n      filename = function() {\n        safe_name <- gsub(\" \", \"_\", input$athlete)\n        paste0(safe_name, \"_\", Sys.Date(), \".xlsx\")\n      },\n      content = function(file) {\n        sheets <- list(\n          \"Profiling_Data\" = rv$data,\n          \"Training_Session\" = rv_training$df,\n          \"Variable_Loading\" = rv_variable$df\n        )\n        write_xlsx(sheets, path = file)\n      }\n    )\n    \n    # B) PLOT DOWNLOAD (PNG)\n    output$download_plot <- downloadHandler(\n      filename = function() {\n        safe_name <- gsub(\" \", \"_\", input$athlete)\n        paste0(safe_name, \"_Profile_\", Sys.Date(), \".png\")\n      },\n      content = function(file) {\n        # Speichert den aktuell angezeigten Plot (reactive_plot)\n        ggsave(file, plot = reactive_plot(), width = 13, height = 8, dpi = 300)\n      }\n    )\n    \n  })\n}\n\n# ==========================================================\n# MAIN APPLICATION\n# ==========================================================\nui <- navbarPage(\"L-V Profiling System\",\n                 tabPanel(\"Paul P.\", athleteModuleUI(\"athlete1\", \"Paul Panglisch\")),\n                 tabPanel(\"Anton\", athleteModuleUI(\"athlete2\", \"Anton Müller\")),\n                 tabPanel(\"Eric\", athleteModuleUI(\"athlete3\", \"Eric Zerau\")),\n                 tabPanel(\"Paul G.\", athleteModuleUI(\"athlete4\", \"Paul Grave\")),\n                 tabPanel(\"Max\", athleteModuleUI(\"athlete5\", \"Max Kuhn\")),\n                 tabPanel(\"Nicola\", athleteModuleUI(\"athlete6\", \"Nicola Volk\")),\n                 tabPanel(\"Hermano\", athleteModuleUI(\"athlete7\", \"Max Müller\")),\n                 tabPanel(\"Athlete 8\", athleteModuleUI(\"athlete8\", \"Athlete 8\"))\n)\n\nserver <- function(input, output, session) {\n  \n  athlete_data <- list(\n    athlete1 = list(mass = 98, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(9.57, 7.17, 5.15, 3.90, NA, NA)),\n    athlete2 = list(mass = 71, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(8.33, 7.13, 5.41, 3.84, NA, NA)),\n    athlete3 = list(mass = 86, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(7.62, 6.15, 4.69, 3.27, NA, NA)),\n    athlete4 = list(mass = 82, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(8.07, 6.5, 4.84, 3.23, NA, NA)),\n    athlete5 = list(mass = 83, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(9.03, 6.43, 4.55, 3.27, NA, NA)),\n    athlete6 = list(mass = 114,BW = c(1, 10, 20, 30, NA, NA), vpeak = c(9.30, 7.50, 5.80, 4.3, NA, NA)),\n    athlete7 = list(mass = 86, BW = c(1, 10, 20, 30, NA, NA), vpeak = c(8.56, 7.29, 5.04, 3.67, NA, NA)),\n    athlete8 = list(BW = c(1, 10, 20, 30, NA, NA), vpeak = c(9.20, 7.40, 5.70, 4.2, NA, NA))\n  )\n  \n  athleteModuleServer(\"athlete1\", athlete_data$athlete1)\n  athleteModuleServer(\"athlete2\", athlete_data$athlete2)\n  athleteModuleServer(\"athlete3\", athlete_data$athlete3)\n  athleteModuleServer(\"athlete4\", athlete_data$athlete4)\n  athleteModuleServer(\"athlete5\", athlete_data$athlete5)\n  athleteModuleServer(\"athlete6\", athlete_data$athlete6)\n  athleteModuleServer(\"athlete7\", athlete_data$athlete7)\n  athleteModuleServer(\"athlete8\", athlete_data$athlete8)\n}\n\n# HIER WIRD DIE APP GESTARTET\nshinyApp(ui = ui, server = server)\n","type":"text"}]
